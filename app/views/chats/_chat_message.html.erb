<%# views/messages/_chat_message.html.erb %>

  <% if message.user_id === current_user.id %>
    <div class="row message-body">
      <div class="col-sm-12 message-main-sender">
        <div class="sender my-1 p-1">
          <div class="messages">
           <% start = message.content.index("http")%>
            <% if start != nil %>
              <% check = 0 %>
              <% length = message.content.size %>
<%= length %>
                  <% ends = message.content.index("\n",start) %>

                  <% url = message.content[start.to_i..ends.to_i - 1] %>
                  <% if start == 0 %>
                    <% messages = message.content.gsub(/#{url}/,"") %>
                    <span>
                       <a href="<%= url %>" target="_blank" rel="noopener noreferrer"><%= url %></a>
                      <%=safe_join(messages.split("\n"),tag(:br))%>
                     </span>
                    <% check =+ url.size + messages.size %>
<%= check %>
                  <% start = ends.to_i %>
                  <% else %>
                    <% first = message.content[0..start.to_i-1] %>
                    <% messages = message.content.gsub(/#{url}|#{first}/, url => "", first => "") %>
                <% first + "\n" %>
                    <span>
                      <%= safe_join(first.split("\n"),tag(:br)) %><br>
                       <a href="<%= url %>" target="_blank" rel="noopener noreferrer"><%= url %></a>
                      <%=safe_join(messages.split("\n"),tag(:br))%>
                     </span>
                      <% check =+ first.size+ url.size + messages.size %>
                <%= check %>
                    <% start = ends.to_i %>
                  <% end %>

            <% else %>
            <%=safe_join(message.content.split("\n"),tag(:br))%>
            <% end %>
          </div>
        </div>
      </div>
      <% if message.created_at.to_date === Date.today %>
        <span class="text-gray small" style="text-align: right"><%= message.created_at.strftime("今日 %H:%M") %></span>
      <% else %>
        <span class="text-gray small" style="text-align: right"><%= message.created_at.strftime("%H:%M") %></span>
      <% end %>
    </div>
  <% else %>
    <div class="row message-body">
      <div class="col-sm-12 message-main-receiver">
        <div class="receiver my-1 p-1">
          <div class="messages">
            <% start = message.content.index("http")%>
            <% if start != nil %>
              <% url = message.content.sub(/\r\n.*|\r.*|\n.*|\s.*|\t.*/m, "") %>
              <% messages = message.content.gsub(/#{url}/,"") %>
              <span>
                <a href="<%= url %>" target="_blank" rel="noopener noreferrer"><%= url %></a>
                <%=safe_join(messages.split("\n"),tag(:br))%>
              </span>
            <% else %>
              <%=safe_join(message.content.split("\n"),tag(:br))%>
            <% end %>
          </div>
        </div>
      </div>
      <% if message.created_at.to_date === Date.today %>
        <span class="text-gray small"><%= message.created_at.strftime("今日 %H:%M") %></span>
      <% else %>
        <span class="text-gray small"><%= message.created_at.strftime("%H:%M") %></span>
      <% end %>
    </div>
  <% end %>